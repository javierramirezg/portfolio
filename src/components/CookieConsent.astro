---
import { getCollection } from 'astro:content';

const siteConfig = (await getCollection('site'))[0];
const cookieTypes = siteConfig.data.cookies?.types || [];
const cookiePolicyUrl = '/cookie-policy/';
---

<cookie-consent>
	<div class="cookie-banner" role="dialog" aria-labelledby="cookie-title" aria-live="polite">
		<div class="cookie-content">
			<div class="cookie-text">
				<h2 id="cookie-title">Uso de Cookies</h2>
				<p>
					Utilizamos cookies para mejorar su experiencia en nuestro sitio web.
					Puede aceptar todas las cookies, rechazarlas o gestionar sus preferencias.
					Para más información, consulte nuestra <a href={cookiePolicyUrl}>Política de Cookies</a>.
				</p>
				{cookieTypes.length > 0 && (
					<details class="cookie-details">
						<summary>Gestionar preferencias de cookies</summary>
						<div class="cookie-types">
							{cookieTypes.map((type) => (
								<label class="cookie-type">
									<input
										type="checkbox"
										name="cookie-type"
										value={type.name}
										checked={type.required}
										disabled={type.required}
									/>
									<div class="cookie-type-info">
										<strong>{type.name}</strong>
										{type.required && <span class="required-badge">Obligatoria</span>}
										<p>{type.description}</p>
									</div>
								</label>
							))}
						</div>
					</details>
				)}
			</div>
			<div class="cookie-actions">
				<button class="btn btn-secondary" data-action="reject">
					Rechazar
				</button>
				<button class="btn btn-primary" data-action="accept">
					Aceptar todas
				</button>
			</div>
		</div>
	</div>
</cookie-consent>

<style>
	.cookie-banner {
		position: fixed;
		bottom: 0;
		left: 0;
		right: 0;
		z-index: 1000;
		padding: 1.5rem;
		background-color: var(--gray-999);
		border-top: 1px solid var(--gray-800);
		box-shadow: var(--shadow-lg);
		transform: translateY(100%);
		transition: transform var(--theme-transition);
	}

	.cookie-banner[data-visible="true"] {
		transform: translateY(0);
	}

	.cookie-content {
		max-width: 1200px;
		margin: 0 auto;
		display: flex;
		flex-direction: column;
		gap: 1.5rem;
	}

	.cookie-text {
		flex: 1;
	}

	.cookie-text h2 {
		font-size: var(--text-lg);
		color: var(--gray-0);
		margin-bottom: 0.5rem;
	}

	.cookie-text p {
		color: var(--gray-200);
		line-height: 1.6;
		margin-bottom: 1rem;
	}

	.cookie-text a {
		color: var(--accent-regular);
		text-decoration: underline;
		text-underline-offset: 0.25em;
	}

	.cookie-text a:hover,
	.cookie-text a:focus {
		color: var(--accent-dark);
	}

	.cookie-details {
		margin-top: 1rem;
	}

	.cookie-details summary {
		cursor: pointer;
		color: var(--accent-regular);
		font-weight: 600;
		user-select: none;
	}

	.cookie-details summary:hover {
		color: var(--accent-dark);
	}

	.cookie-types {
		margin-top: 1rem;
		display: flex;
		flex-direction: column;
		gap: 1rem;
		padding: 1rem;
		background-color: var(--gray-900);
		border-radius: 0.5rem;
	}

	.cookie-type {
		display: flex;
		gap: 1rem;
		cursor: pointer;
	}

	.cookie-type input[type="checkbox"] {
		margin-top: 0.25rem;
		cursor: pointer;
	}

	.cookie-type input[type="checkbox"]:disabled {
		cursor: not-allowed;
		opacity: 0.6;
	}

	.cookie-type-info {
		flex: 1;
	}

	.cookie-type-info strong {
		color: var(--gray-100);
		font-weight: 600;
		display: inline-block;
		margin-right: 0.5rem;
	}

	.required-badge {
		display: inline-block;
		padding: 0.125rem 0.5rem;
		font-size: var(--text-sm);
		background-color: var(--accent-overlay);
		color: var(--accent-regular);
		border-radius: 0.25rem;
	}

	.cookie-type-info p {
		margin-top: 0.25rem;
		color: var(--gray-300);
		font-size: var(--text-sm);
	}

	.cookie-actions {
		display: flex;
		gap: 1rem;
		flex-wrap: wrap;
	}

	.btn {
		padding: 0.75rem 1.5rem;
		border: none;
		border-radius: 0.5rem;
		font-size: var(--text-base);
		font-weight: 600;
		cursor: pointer;
		transition: background-color var(--theme-transition), transform var(--theme-transition);
	}

	.btn:hover {
		transform: translateY(-1px);
	}

	.btn:active {
		transform: translateY(0);
	}

	.btn-primary {
		background-color: var(--accent-regular);
		color: var(--accent-text-over);
	}

	.btn-primary:hover {
		background-color: var(--accent-dark);
	}

	.btn-secondary {
		background-color: var(--gray-800);
		color: var(--gray-0);
	}

	.btn-secondary:hover {
		background-color: var(--gray-700);
	}

	@media (min-width: 50em) {
		.cookie-content {
			flex-direction: row;
			align-items: flex-start;
		}

		.cookie-actions {
			flex-direction: column;
			min-width: 150px;
		}

		.btn {
			width: 100%;
		}
	}

	@media (prefers-reduced-motion: no-preference) {
		.cookie-banner {
			transition: transform var(--theme-transition);
		}
	}
</style>

<script>
	class CookieConsent extends HTMLElement {
		private storageKey = 'cookie-consent';
		private banner: HTMLElement | null = null;

		connectedCallback() {
			this.banner = this.querySelector('.cookie-banner');
			
			if (!this.hasConsent()) {
				this.showBanner();
				this.attachEventListeners();
			}
		}

		private hasConsent(): boolean {
			if (typeof window === 'undefined') return true;
			return localStorage.getItem(this.storageKey) !== null;
		}

		private showBanner() {
			if (this.banner) {
				// Small delay to ensure styles are loaded
				setTimeout(() => {
					this.banner?.setAttribute('data-visible', 'true');
				}, 100);
			}
		}

		private hideBanner() {
			if (this.banner) {
				this.banner.setAttribute('data-visible', 'false');
				setTimeout(() => {
					this.banner?.remove();
				}, 300);
			}
		}

		private attachEventListeners() {
			const acceptBtn = this.querySelector('[data-action="accept"]');
			const rejectBtn = this.querySelector('[data-action="reject"]');

			acceptBtn?.addEventListener('click', () => this.acceptAll());
			rejectBtn?.addEventListener('click', () => this.rejectAll());
		}

		private acceptAll() {
			const preferences: Record<string, boolean> = {};
			const checkboxes = this.querySelectorAll<HTMLInputElement>('input[name="cookie-type"]');
			
			checkboxes.forEach(checkbox => {
				preferences[checkbox.value] = checkbox.checked || checkbox.disabled;
			});

			localStorage.setItem(this.storageKey, JSON.stringify({
				preferences,
				timestamp: new Date().toISOString()
			}));

			this.hideBanner();
			this.dispatchEvent(new CustomEvent('cookie-consent-updated', {
				detail: { preferences }
			}));
		}

		private rejectAll() {
			const preferences: Record<string, boolean> = {};
			const checkboxes = this.querySelectorAll<HTMLInputElement>('input[name="cookie-type"]');
			
			checkboxes.forEach(checkbox => {
				// Only allow required cookies
				preferences[checkbox.value] = checkbox.disabled && checkbox.checked;
			});

			localStorage.setItem(this.storageKey, JSON.stringify({
				preferences,
				timestamp: new Date().toISOString()
			}));

			this.hideBanner();
			this.dispatchEvent(new CustomEvent('cookie-consent-updated', {
				detail: { preferences }
			}));
		}

		static getConsent(): Record<string, boolean> | null {
			if (typeof window === 'undefined') return null;
			
			const consent = localStorage.getItem('cookie-consent');
			if (!consent) return null;

			try {
				const data = JSON.parse(consent);
				return data.preferences || null;
			} catch {
				return null;
			}
		}
	}

	customElements.define('cookie-consent', CookieConsent);
</script>
